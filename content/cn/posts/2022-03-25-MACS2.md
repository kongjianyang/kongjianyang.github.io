

参考资料：

[这可能是最棒的MACS2使用说明 (360doc.com)](http://www.360doc.com/content/18/0205/00/19913717_727772514.shtml)

[使用MACS2进行差异peak分析_生信修炼手册的博客-CSDN博客](https://blog.csdn.net/weixin_43569478/article/details/108079812)



MACS2作为使用最广泛的peak calling软件，在v2版本中添加了差异peak分析的功能，所有的子命令功能描述如下

![](https://imgconvert.csdnimg.cn/aHR0cHM6Ly9tbWJpei5xcGljLmNuL21tYml6X3BuZy9LQXRSUEJCeWVHNVI5MGNRaWJxS2FibjVKM3ZwSDUyTWZnZUpkRTVwSGQza1BmdVNONEozMTVERVRKclpteFJxVGV0UXNQd3ZCVGdpY24zeFU3Tzdtd2hnLzY0MA?x-oss-process=image/format,png)

通过`bdgdiff`子命令来进行差异peak分析， 该命令不需要基于已有的peak calling结果，只需要输入每个样本对应的bedGraph格式的文件。需要注意的是，该命令只针对两个样本间的差异peak进行设计，适用于没有生物学重复的情况。

对于使用macs2来进行差异peak的完整流程，官方给出了详细的说明文档，链接如下

> https://github.com/taoliu/MACS/wiki/Call-differential-binding-events

可以分为以下3步

#### 1\. 预测插入片段长度

通过`predictd`子命令可以预测样本的fragment size，命令如下

```
macs2 predictd -i input.bam
```

```
#!/bin/bash

module load bioinfo
module load biocontainers/default
module load macs2/2.2.7.1-py39

for i in `ls [A-H][1-9][A-H][1-9][A-H][1-9].bam`;
do
msg="macs2 predictd -i $i";
echo $msg;
macs2 predictd -i $i;
```



#### 2\. peak  calling

在peak calling时，需要添加`-B`参数，这样才可以输出样本对应的bedgraph文件，同时需要保证peak  calling时采用一致的`--extsize`的值，就是第一步预测出来的数值，取多个样本的均值即可。官方也给出了推荐值，对于大多数的转录因子chip\_seq数据，推荐值为200， 对于大部分组蛋白修饰的chip\_seq数据，推荐值为147，命令如下

```
# condition1macs2 callpeak -B -t cond1_ChIP.bam -c cond1_Control.bam -n cond1 --nomodel --extsize 120# condition2macs2 callpeak -B -t cond1_ChIP.bam -c cond1_Control.bam -n cond1 --nomodel --extsize 120 --broad-cutoff 0.1
```

- `-n/--name`表示实验的名字
- `-B/--bdg`: 以bedGraph格式存放*fragment pileup*, *control lambda*, *-log10pvalue* 和*log10qvale*.
- `-q`： q值(最小的FDR)的阈值，默认0.05。可以根据结果进行修正。q值是p值经Benjamini–Hochberg–Yekutieli修正后的值。
- `--broad--cutoff`: 用于过滤 `broad`得到的peak，默认是q值，如果设置 `-p`就用p值。
- `--nomodel`: 这个参数说明不需要MACS去构建模型，也就是说下面的参数除了 `--shift, --extsize`外都会被无视。
- `--extsize`： MACS使用这个参数将read以5'-> 3'衍生至等长片段。比如说你知道你的转录因子的结合区域是200bp，那么参数就是 `--extsize 200`。当且仅当 `--nomodel`和 `--fix-bimodal`设置使用。
- `-g`表示可比对的基因组大小。比如说人类是2.7e9，也就是2.7G，拟南芥根据NCBI显示是119,667,750，也就是1.2e8. 这个参数设置的原因，根据我读发表MACS的那篇文献推测，是因为MACS需要进行全基因组扫描构建双峰模型估计shift size。这个只是我猜测而已，反正根据自己物种来就对了。
- -f/--format FORMAT`用来声明输入的文件格式，目前MACS能够识别的格式有 'ELAND', 'BED', 'ELANDMULTI', 'ELANDEXPORT', 'ELANDMULTIPET' (双端测序), 'SAM', 'BAM', 'BOWTIE', 'BAMPE', 'BEDPE'. 除'BAMPE', 'BEDPE'需要特别声明外，其他格式都可以用 `AUTO

在运行这一步的时候，会输出每个样本过滤之后的reads数目，示意如下

```
# tags after filtering in treatment: 19291269# tags after filtering in control: 12914669
```

这个数值在差异分析中会用到，所以要记录下来。

#### 3\. 差异peak分析

命令如下

```
macs2 bdgdiff --t1 cond1_treat_pileup.bdg --c1 cond1_control_lambda.bdg --t2 cond2_treat_pileup.bdg \--c2 cond2_control_lambda.bdg --d1 12914669 --d2 14444786 -g 60 -l 120 --o-prefix diff_c1_vs_c2
```

其中`-d1`和`-d2`的值就是第二步运行时输出的reads数目，`-o`参数指定输出文件的前缀。运行成功后，会产生3个文件

1.  diff\_c1\_vs\_c2\_c3.0\_cond1.bed
    
2.  diff\_c1\_vs\_c2\_c3.0\_cond2.bed
    
3.  diff\_c1\_vs\_c2\_c3.0\_common.bed
    

其中, con1.bed保存了在condition1中上调的peak, con2.bed保存了在condition2中上调的peak, common.bed文件中保存的是没有达到阈值的，非显著差异peak。

上述3个文件格式是完全相同的，最后一列的内容为log10 likehood ratio值，用来衡量两个条件之间的差异，默认阈值为3，大于阈值的peak为组间差异显著的peak, 这个阈值可以通过`-c`参数进行调整。  



#### 一些解释



This redundancy is consistently applied for both the ChIP and input samples.

> **Why worry about duplicates?** Reads with the same start position are considered duplicates. These duplicates can arise from experimental artifacts, but can also contribute to genuine ChIP-signal.
>
> - **The bad kind of duplicates:** If initial starting material is low this can lead to overamplification of this material before sequencing. Any biases in PCR will compound this problem and can lead to artificially enriched regions. Also blacklisted (repeat) regions with ultra high signal will also be high in duplicates. Masking these regions prior to analysis can help remove this problem.
> - **The good kind of duplicates:** Duplicates will also exist within highly efficient (or even inefficient ChIP) when deeply sequenced. Removal of these duplicates can lead to a saturation and so underestimation of the ChIP signal.
>
> **The take-home:** Consider your enrichment efficiency and sequencing depth. But, because we cannot distinguish between the good and the bad, best practice is to remove duplicates prior to peak calling. Retain duplicates for differential binding analysis. Also, if you are expecting binding in repetitive regions keep duplicates and multiple mappers.

